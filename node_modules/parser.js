let buffer = new Buffer(0)

Parser = function parser(emitter, data) {
	buffer = Buffer.concat([buffer, data])

	let startByte = buffer.indexOf('!')
	while (startByte != -1) {
		let payloadSize = buffer.readUInt8(startByte + 1)
		let payloadStart = startByte + 2
		let payloadEnd = payloadStart + payloadSize

		/*
		 *	If payloadEnd is greater then length then the
		 *	packet did not arrived yet, slice the buffer and return
		 */
		if (payloadEnd > buffer.length) {
			buffer = buffer.slice(startByte)
			return
		}

		emitter.emit('data', buffer.slice(payloadStart, payloadEnd))
		startByte = buffer.indexOf('!', payloadEnd)
	}

	/*
	 * If we leave the loop then we consumed the whole buffer
	 */
	buffer = Buffer(0)
}
